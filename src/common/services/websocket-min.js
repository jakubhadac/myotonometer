"use strict";var _createClass=function(){function a(b,c){for(var e,d=0;d<c.length;d++)e=c[d],e.enumerable=e.enumerable||!1,e.configurable=!0,"value"in e&&(e.writable=!0),Object.defineProperty(b,e.key,e)}return function(b,c,d){return c&&a(b.prototype,c),d&&a(b,d),b}}();Object.defineProperty(exports,"__esModule",{value:!0});function _classCallCheck(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")}var action={GET:"get",GET_ALL:"get_all",ADD:"add",MODIFY:"modify",REMOVE:"remove",BIND:"bind",UNBIND:"unbind"},connectionState={CONNECTING:"connecting",CONNECTED:"connected",CLOSED:"closed_connection",ERROR:"error_occured"},WebsocketClient=function(){function a(){_classCallCheck(this,a),this.requests_=[],this.callbacks_=[],this.onOpen=function(){},this.onClose=function(){},this.onError=function(){}}return _createClass(a,[{key:"create",value:function create(b){var c=b.secure?"wss://":"ws://";return this.host_=b.host||"localhost",this.port_=b.port||4e3,this.state_=connectionState.CONNECTING,this.ws_=new WebSocket(c+this.host_+":"+this.port_),this.ws_.onopen=this.on_open.bind(this),this.ws_.onclose=this.on_close.bind(this),this.ws_.onerror=this.on_error.bind(this),this.ws_.onmessage=this.on_message.bind(this),this}},{key:"_dataRequest",value:function _dataRequest(b,c,d){return d="undefined"==typeof d?{}:d,{action:b,location:c,content:d}}},{key:"_handleRequest",value:function _handleRequest(b,c){c="undefined"==typeof c?function(){}:c;var d={data:b,callback:c};this.requests_.push(d),this.state_==connectionState.CONNECTED&&this.ws_.send(JSON.stringify(b))}},{key:"onOpen",value:function onOpen(b){this.onOpen=b}},{key:"onClose",value:function onClose(b){this.onClose=b}},{key:"onError",value:function onError(b){this.onError=b}},{key:"get",value:function get(b,c,d){var e=this._dataRequest(action.GET,b);e.pattern=c,this._handleRequest(e,d)}},{key:"get_all",value:function get_all(b,c){console.log("Function is DEPRECATED. Please use get(uri, pattern, callback)."),this._handleRequest(this._dataRequest(action.GET_ALL,b),c)}},{key:"add",value:function add(b,c,d){this._handleRequest(this._dataRequest(action.ADD,b,c),d)}},{key:"modify",value:function modify(b,c,d){this._handleRequest(this._dataRequest(action.MODIFY,b,c),d)}},{key:"remove",value:function remove(b,c){this._handleRequest(this._dataRequest(action.REMOVE,b),function(d,e){c(e)})}},{key:"bind",value:function bind(b,c,d){var e=this.callbacks_.filter(function(g){return g.location==b});if(0==e.length){var f=this;this._handleRequest(this._dataRequest(action.BIND,b),function(g,h){0==h.status&&f.callbacks_.push({location:b,callback:d}),c(g,h)})}else console.log("Cannot bind action. Already exists.")}},{key:"unbind",value:function unbind(b,c){for(var d=0;d!=this.callbacks_.length;d++)if(this.callbacks_[d].location==b){this._handleRequest(this._dataRequest(action.UNBIND,b),function(e,f){c(f)}),this.callbacks_.slice(d,0);break}}},{key:"close",value:function close(){this.state_=connectionState.CLOSED,this.ws_.close()}},{key:"opened",value:function opened(){return 1===this.ws_.readyState}},{key:"on_open",value:function on_open(){console.log("WebSocket client is ready to use."),this.state_=connectionState.CONNECTED,this.onOpen();var _iteratorNormalCompletion=!0,_didIteratorError=!1,_iteratorError=void 0;try{for(var e,c,d=this.requests_[Symbol.iterator]();!(_iteratorNormalCompletion=(e=d.next()).done);_iteratorNormalCompletion=!0)c=e.value,this.ws_.send(JSON.stringify(c.data))}catch(f){_didIteratorError=!0,_iteratorError=f}finally{try{!_iteratorNormalCompletion&&d.return&&d.return()}finally{if(_didIteratorError)throw _iteratorError}}}},{key:"on_close",value:function on_close(){this.ws_.close(),this.onClose()}},{key:"on_error",value:function on_error(){1!==this.ws_.readyState&&(this.state_=connectionState.ERROR,console.log("Connection could not be established on host "+this.host_+":"+this.port_),this.onError())}},{key:"_is_response",value:function _is_response(b){return"undefined"==typeof b.location&&"undefined"==typeof b.action}},{key:"_handleResponse",value:function _handleResponse(b){var c=this.requests_.shift();0===b.status?c.callback(b.content,{status:b.status}):c.callback(void 0,{status:b.status,message:b.content.message})}},{key:"_handlePush",value:function _handlePush(b){var c=this.callbacks_.filter(function(d){return 0==b.location.indexOf(d.location)});0<c.length&&(b.location.replace(c[0].location,""),c[0].callback(b))}},{key:"on_message",value:function on_message(b){var c=JSON.parse(b.data);this._is_response(c)?this._handleResponse(c):this._handlePush(c)}}]),a}();var wsclient=new WebsocketClient;exports.wsclient=wsclient,exports.action=action,exports.connectionState=connectionState;